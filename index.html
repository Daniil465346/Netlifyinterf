<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .integration-flow {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .flow-step {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
        }

        .flow-number {
            background: white;
            color: #667eea;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }

        input, select, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

            button:hover {
                background: #0056b3;
            }

        .result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f8f9fa;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        .notification {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background: #28a745;
        }

        .status-inactive {
            background: #dc3545;
        }

        .api-status {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>üöÄ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</h1>

    <div class="integration-flow">
        <h3>üîó –°—Ö–µ–º–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤</h3>
        <div class="flow-step">
            <div class="flow-number">1</div>
            <div>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</div>
        </div>
        <div class="flow-step">
            <div class="flow-number">2</div>
            <div>Frontend (Netlify) ‚Üí Investment API (Amvera)</div>
        </div>
        <div class="flow-step">
            <div class="flow-number">3</div>
            <div>Investment API ‚Üí Email Notification API (Amvera)</div>
        </div>
        <div class="flow-step">
            <div class="flow-number">4</div>
            <div>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ email</div>
        </div>
    </div>

    <div class="dashboard">
        <!-- –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Å–µ–∫—Ü–∏—é –≤ –Ω–∞—á–∞–ª–æ dashboard -->
        <div class="section">
            <h3>üìß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>
            <div class="api-status">
                <span>–¢–µ–∫—É—â–∏–π email:</span>
                <span id="currentEmail">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <input type="email" id="userEmail" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π">
            <button onclick="setUserEmail()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å email</button>
            <button onclick="sendTestEmail()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ</button>
            <div id="emailResult" class="result"></div>
        </div>
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div>
            <div class="section">
                <h3>üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤</h3>
                <div class="api-status">
                    <span>Investment API:</span>
                    <span><span class="status-indicator status-active"></span> Online</span>
                </div>
                <div class="api-status">
                    <span>Email Service:</span>
                    <span><span class="status-indicator status-active"></span> Online</span>
                </div>
                <button onclick="checkServices()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
            </div>

            <div class="section">
                <h3>üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
                <select id="calcSecurityId" onchange="updatePrices()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—É–º–∞–≥—É</option>
                </select>
                <input type="number" id="calcQuantity" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" value="10">
                <input type="number" id="calcCurrentPrice" placeholder="–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞" step="0.01" readonly>
                <input type="number" id="calcCommission" placeholder="–ö–æ–º–∏—Å—Å–∏—è" value="5.00" step="0.01">
                <button onclick="calculate()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å</button>
                <div id="calcResult" class="result"></div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div>
            <div class="section">
                <h3>üíæ –ù–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º</h3>
                <select id="opSecurityId">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—É–º–∞–≥—É</option>
                </select>
                <input type="number" id="opQuantity" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" value="10">
                <input type="number" id="opPrice" placeholder="–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏" step="0.01">
                <input type="number" id="opCommission" placeholder="–ö–æ–º–∏—Å—Å–∏—è" value="5.00" step="0.01">
                <input type="number" id="opTargetPrice" placeholder="–¶–µ–Ω–∞ –¥–ª—è –≤—ã–∫—É–ø–∞" step="0.01">
                <button onclick="addOperation()">üìß –î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
                <div id="opResult" class="result"></div>
            </div>

            <div class="section">
                <h3>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤</h3>
                <button onclick="getActiveTriggers()">–ü–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞</button>
                <button onclick="checkAllTriggers()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Å–µ—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤</button>
                <div id="triggersResult" class="result"></div>
            </div>
        </div>
    </div>

    <div class="section">
        <h3>üìà –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
        <button onclick="getOperations()">–û–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        <div id="operationsResult" class="result"></div>
    </div>

    <script>
        const INVESTMENT_API = 'https://pr4-daniil465346.amvera.io/api/investment';
        const EMAIL_API = 'https://apiemailr-daniil465346.amvera.io/api/notifications';
        let securities = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function loadSecurities() {
            try {
                const response = await fetch(`${INVESTMENT_API}/securities`);
                securities = await response.json();

                securities.forEach(security => {
                    const option = `<option value="${security.id}">${security.ticker} - $${security.currentPrice}</option>`;
                    document.getElementById('calcSecurityId').innerHTML += option;
                    document.getElementById('opSecurityId').innerHTML += option;
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—É–º–∞–≥:', error);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
        async function checkServices() {
            try {
                const investmentResponse = await fetch(`${INVESTMENT_API}/securities`);
                document.querySelectorAll('.status-indicator')[0].className =
                    investmentResponse.ok ? 'status-indicator status-active' : 'status-indicator status-inactive';

                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É email —Å–µ—Ä–≤–∏—Å–∞
                alert('–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!');
            } catch (error) {
                alert('–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–µ—Ä–≤–∏—Å—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω
        function updatePrices() {
            const security = securities.find(s => s.id == document.getElementById('calcSecurityId').value);
            if (security) {
                document.getElementById('calcCurrentPrice').value = security.currentPrice;
                document.getElementById('opPrice').value = security.currentPrice;
                document.getElementById('opTargetPrice').value = (security.currentPrice * 0.9).toFixed(2);
            }
        }

        // –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
        async function calculate() {
            const securityId = document.getElementById('calcSecurityId').value;
            const quantity = document.getElementById('calcQuantity').value;
            const price = document.getElementById('calcCurrentPrice').value;
            const commission = document.getElementById('calcCommission').value;

            if (!securityId) return showResult('calcResult', '–í—ã–±–µ—Ä–∏—Ç–µ –±—É–º–∞–≥—É', false);

            try {
                const response = await fetch(`${INVESTMENT_API}/calculate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        securityId: parseInt(securityId),
                        quantity: parseInt(quantity),
                        purchasePricePerShare: parseFloat(price),
                        commission: parseFloat(commission)
                    })
                });

                const result = await response.json();
                const security = securities.find(s => s.id == securityId);

                document.getElementById('calcResult').innerHTML =
                    `<strong>${security.ticker}: $${result.totalCost}</strong><br>
                         –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${quantity} –∞–∫—Ü–∏–π | –¶–µ–Ω–∞: $${price} | –ö–æ–º–∏—Å—Å–∏—è: $${commission}`;
                document.getElementById('calcResult').className = 'result success';

            } catch (error) {
                showResult('calcResult', '–û—à–∏–±–∫–∞: ' + error.message, false);
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π
        async function addOperation() {
            const securityId = document.getElementById('opSecurityId').value;
            const quantity = document.getElementById('opQuantity').value;
            const price = document.getElementById('opPrice').value;
            const commission = document.getElementById('opCommission').value;
            const targetPrice = document.getElementById('opTargetPrice').value;

            if (!securityId) return showResult('opResult', '–í—ã–±–µ—Ä–∏—Ç–µ –±—É–º–∞–≥—É', false);

            const operation = {
                securityId: parseInt(securityId),
                quantity: parseInt(quantity),
                purchasePricePerShare: parseFloat(price),
                commission: parseFloat(commission),
                targetBuyPrice: parseFloat(targetPrice)
            };

            try {
                const response = await fetch(`${INVESTMENT_API}/operation`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(operation)
                });

                const result = await response.json();

                let message = result.message;
                if (result.notificationSent) {
                    message += '\n\nüìß –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ email!';
                }
                if (result.triggerActivated) {
                    message += '\n\nüö® –¢–†–ò–ì–ì–ï–† –°–†–ê–ë–û–¢–ê–õ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.';
                }

                showResult('opResult', message, true);

            } catch (error) {
                showResult('opResult', '–û—à–∏–±–∫–∞: ' + error.message, false);
            }
        }

        // –ê–∫—Ç–∏–≤–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã
        async function getActiveTriggers() {
            try {
                const response = await fetch(`${INVESTMENT_API}/active-triggers`);
                const triggers = await response.json();

                const result = document.getElementById('triggersResult');
                result.innerHTML = triggers.length ?
                    triggers.map(t => `
                            <div class="notification">
                                <strong>${t.securityTicker}</strong><br>
                                ${t.message}<br>
                                <small>–¶–µ–ª—å: $${t.targetPrice} | –¢–µ–∫—É—â–∞—è: $${t.currentPrice} | –î–∏—Å—Ç–∞–Ω—Ü–∏—è: ${t.distancePercent}%</small>
                            </div>
                        `).join('') : '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤';

            } catch (error) {
                showResult('triggersResult', '–û—à–∏–±–∫–∞: ' + error.message, false);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
        async function checkAllTriggers() {
            try {
                const response = await fetch(`${INVESTMENT_API}/check-all-triggers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                showResult('triggersResult',
                    `–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤: ${result.totalChecked}\n–°—Ä–∞–±–æ—Ç–∞–ª–æ: ${result.activatedTriggers.length}\n–í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏: ${result.checkedAt}`,
                    true);

            } catch (error) {
                showResult('triggersResult', '–û—à–∏–±–∫–∞: ' + error.message, false);
            }
        }

        // –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
        async function getOperations() {
            try {
                const response = await fetch(`${INVESTMENT_API}/operations`);
                const data = await response.json();

                const operationsList = data.map(op =>
                    `#${op.id} ${op.securityTicker} - ${op.quantity}—à—Ç √ó $${op.purchasePricePerShare} = $${op.totalCost}` +
                    (op.targetBuyPrice ? ` üéØ –¢—Ä–∏–≥–≥–µ—Ä: $${op.targetBuyPrice}` : '') +
                    (op.hasTrigger ? ' üìß' : '')
                ).join('\n');

                showResult('operationsResult', operationsList || '–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π', true);
            } catch (error) {
                showResult('operationsResult', '–û—à–∏–±–∫–∞: ' + error.message, false);
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
        function showResult(elementId, message, isSuccess) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${isSuccess ? 'success' : 'error'}`;
        }


        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ email –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        async function loadCurrentEmail() {
            try {
                const response = await fetch(`${EMAIL_API}/current-email`);
                const data = await response.json();
                document.getElementById('currentEmail').textContent = data.email;

                if (data.isDefault) {
                    document.getElementById('currentEmail').innerHTML += ' <small style="color: orange;">(–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</small>';
                }
            } catch (error) {
                document.getElementById('currentEmail').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ email:', error);
            }
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function setUserEmail() {
            const email = document.getElementById('userEmail').value;

            if (!email || !email.includes('@')) {
                showResult('emailResult', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å', false);
                return;
            }

            try {
                const response = await fetch(`${EMAIL_API}/set-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });

                const result = await response.json();

                if (result.success) {
                    showResult('emailResult', `‚úÖ ${result.message}`, true);
                    document.getElementById('currentEmail').textContent = email;
                    document.getElementById('userEmail').value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ
                } else {
                    showResult('emailResult', `‚ùå –û—à–∏–±–∫–∞: ${result.error}`, false);
                }
            } catch (error) {
                showResult('emailResult', '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–∏—Å–æ–º', false);
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–∏—Å—å–º–∞
        async function sendTestEmail() {
            try {
                const response = await fetch(`${EMAIL_API}/send-test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    showResult('emailResult', `‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${result.message}`, true);
                } else {
                    showResult('emailResult', `‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${result.message}`, false);
                }
            } catch (error) {
                showResult('emailResult', '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–∏—Å–æ–º', false);
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é showResult –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ email —Å–µ–∫—Ü–∏–∏
        function showResult(elementId, message, isSuccess) {
            const element = document.getElementById(elementId);
            element.innerHTML = message; // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML –¥–ª—è —ç–º–æ–¥–∑–∏
            element.className = `result ${isSuccess ? 'success' : 'error'}`;
        }

        // –ó–∞–ø—É—Å–∫
        loadSecurities();
        checkServices();
        getActiveTriggers();
        loadCurrentEmail();
    </script>
</body>
</html>
